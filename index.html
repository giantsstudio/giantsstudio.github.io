<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giants Studio</title>
    <style type="text/css">
        html, body, #renderCanvas{
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
        }
    
    </style>

    <script src="https://cdn.babylonjs.com/babylon.max.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>

</head>
<body>

    <canvas id="renderCanvas" width="1800" height="1200"></canvas>

    <script>

        var canvas;
        var engine;
        var scene;
        

        document.addEventListener("DOMContentLoaded", startGame);

        function startGame(){
            canvas = document.getElementById("renderCanvas");
            engine = new BABYLON.Engine(canvas, true);
            canvas.style.width = '100%';
            canvas.style.width = '100%';
            scene = createScene();


            engine.runRenderLoop(function () {

            
                
                scene.render();
            });
        }

     

        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;
            

            createCamera();

            createLight();

            createFightingRing();

            createGladiator();

            var box = BABYLON.Mesh.CreateBox("crate", 50, scene);
            box.material = new BABYLON.StandardMaterial("Mat", scene);
            box.material.diffuseTexture = new BABYLON.Texture("asset/sand/sand_baseColor.png", scene);
            box.material.diffuseTexture.hasAlpha = true;
            box.position = new BABYLON.Vector3(0, -130, 100);
            box.checkCollisions = true;
            box.applyGravity = true;
            box.ellipsoid = new BABYLON.Vector3(1, 1, 1);

            BABYLON.SceneLoader.ImportMesh("", "asset/sand/", "sand.glb", scene, function(groundMeshes){
            groundMeshes[0].name = "sandGround";
            var groundMeshes = groundMeshes[0];
            groundMeshes.position = new BABYLON.Vector3(0, 0, 0)
            });
            BABYLON.SceneLoader.ImportMesh("", "asset/stadium/", "stadium.glb", scene, function(stadiumMeshes){
            newMeshes[0].name = "stadium";
            var stadiumMeshes = stadiumMeshes[0];
            stadiumMeshes.position = new BABYLON.Vector3(0, 0, 0)
            stadiumMeshes.checkCollisions = true;
            });

            var inputMap ={};
            scene.actionManager = new BABYLON.ActionManager(scene);
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {								
                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {								
                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));

                BABYLON.SceneLoader.ImportMesh("", "asset/Dude/", "dude.babylon", scene, function (newMeshes, particleSystems, skeletons) {
                var maximus = newMeshes[0];
                maximus.position.y = -165;
                maximus.checkCollisions = true;
                maximus.applyGravity = true;
                maximus.ellipsoid = new BABYLON.Vector3(1, 1, 1);
                try{
                    
                var skeleton = skeletons[0];
                skeleton.animationPropertiesOverride = new BABYLON.AnimationPropertiesOverride();
                skeleton.animationPropertiesOverride.enableBlending = true;
                skeleton.animationPropertiesOverride.blendingSpeed = 0.55;
                skeleton.animationPropertiesOverride.loopMode = 1;

                
                var animating = false;
                // Game/Render loop
                scene.onBeforeRenderObservable.add(()=>{
            var keydown = false;
            if(inputMap["w"]){
                newMeshes[0].position.z+=0.5
                newMeshes[0].rotation.y = 2*Math.PI/2
                keydown=true;
            } 
            if(inputMap["a"]){
                newMeshes[0].position.x-=0.5
                newMeshes[0].rotation.y = Math.PI/2
                keydown=true;
            } 
            if(inputMap["s"]){
                newMeshes[0].position.z-=0.5
                newMeshes[0].rotation.y = 0
                keydown=true;
            } 
            if(inputMap["d"] ){
                newMeshes[0].position.x+=0.5
                newMeshes[0].rotation.y = 3*Math.PI/2
                keydown=true;
            }
            if(inputMap["w"] && inputMap["a"]){
                newMeshes[0].position.z+=0.05
                newMeshes[0].position.x-=0.05
                newMeshes[0].rotation.y = 1.5*Math.PI/2
                keydown=true;
            }
            if(inputMap["w"] && inputMap["d"]){
                newMeshes[0].position.z+=0.05
                newMeshes[0].position.x-=0.05
                newMeshes[0].rotation.y = 2.5*Math.PI/2
                keydown=true;
            }
            if(inputMap["s"] && inputMap["d"]){
                newMeshes[0].position.z+=0.05
                newMeshes[0].position.x-=0.05
                newMeshes[0].rotation.y = 3.5*Math.PI/2
                keydown=true;
            }
            if(inputMap["s"] && inputMap["a"]){
                newMeshes[0].position.z+=0.05
                newMeshes[0].position.x-=0.05
                newMeshes[0].rotation.y = 4.5*Math.PI/2
                keydown=true;
            }
            if(keydown){
                if(!animating){
                    animating = true;
                    scene.beginAnimation(skeleton, 0, 120, true, 1.0);
                    console.log(animating);
                }
            }else{
                animating = false;
                scene.stopAnimation(skeleton)
                console.log(animating);
            }
        })
        }catch(e){console.log(e)}
    });
            
           

            return scene;
        }

        function createFightingRing(){
        
        }

        function createGladiator(){

        }

        function createLight(){
            var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 15, 0), scene); 
        }

        function createCamera(){
                var camera = new BABYLON.FreeCamera("myCam", new BABYLON.Vector3(0,2,-30), scene);
                camera.position.y = 350;
                camera.position.z = -620;
                camera.position.x = -380;
                camera.rotation.x = 0.5;
                camera.rotation.y = 0.5;
               

                camera.attachControl(canvas, true);
        }

        window.addEventListener("resize", function () {
            engine.resize();
        });

    </script>

</body>
</html>